<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="jhs">

<!-- 	<select id="getMainBanner_advo" resultType="String">
		select advertisement_num, file_name, url, start_date, period, status
		from tbl_advertisement
		where division = '메인'
		order by advertisement_num
	</select> -->
	
<!-- 	<select id="getCurriList" resultType="com.gukmo.board.model.CurriculumVO">
		select B.board_num as board_num, academy_name, subject,
			   to_char(curriculum_start_date, 'yyyy-mm-dd') as c_start_date, curriculum_period
		from tbl_board B join tbl_curriculum C
		on B.board_num = C.fk_board_num		
	</select> -->
	
	
	
	<!-- 메인 게시판 영역 -->
	<select id ="getFreeBoardList" resultType="com.gukmo.board.model.BoardVO">
		select board_num,nickname, point as writer_point , profile_image,
		       detail_category , subject,
		       content , write_date, views, comment_cnt, like_cnt
		from
		(
		select board_num, B.nickname as nickname, M.point as point, M.profile_image as profile_image,
		       detail_category , subject,
		       content , write_date, views, comment_cnt, like_cnt
		from tbl_board B left join tbl_member M
		on B.nickname = M.nickname
		where detail_category = '자유게시판' 
		order by write_date desc
		)
		where rownum between 1 and 5
	</select>
	
	
	<select id ="getStudyBoardList" resultType="com.gukmo.board.model.BoardVO">
		select board_num,nickname, point as writer_point, profile_image,
		       detail_category , subject,
		       content , write_date, views, comment_cnt, like_cnt
		from
		(
		select board_num, B.nickname as nickname, M.point as point, M.profile_image as profile_image,
		       detail_category , subject,
		       content , write_date, views, comment_cnt, like_cnt
		from tbl_board B left join tbl_member M
		on B.nickname = M.nickname
		where detail_category = '스터디' 
		order by write_date desc
		)
		where rownum between 1 and 5
	</select>
	
	
	<select id ="getQnaBoardList" resultType="com.gukmo.board.model.BoardVO">
		select board_num,nickname, point as writer_point, profile_image,
		       detail_category , subject,
		       content , write_date, views, comment_cnt, like_cnt
		from
		(
		select board_num, B.nickname as nickname, M.point as point, M.profile_image as profile_image,
		       detail_category , subject,
		       content , write_date, views, comment_cnt, like_cnt
		from tbl_board B left join tbl_member M
		on B.nickname = M.nickname
		where detail_category = 'QnA' 
		order by write_date desc
		)
		where rownum between 1 and 5
	</select>
	
	
	<select id ="getReviewBoardList" resultType="com.gukmo.board.model.BoardVO">
		select board_num,nickname, point as writer_point, profile_image,
		       detail_category , subject,
		       content , write_date, views, comment_cnt, like_cnt
		from
		(
		select board_num, B.nickname as nickname, M.point as point, M.profile_image as profile_image,
		       detail_category , subject,
		       content , write_date, views, comment_cnt, like_cnt
		from tbl_board B left join tbl_member M
		on B.nickname = M.nickname
		where detail_category = '수강/취업후기' 
		order by write_date desc
		)
		where rownum between 1 and 5
	</select>
	
	
	
	<!-- 검색창 영역 -->
	
	<!-- association 으로 선언된 AcademyVO 매핑 -->
	<resultMap id="academy" type="com.gukmo.board.model.AcademyVO">
		<id property="fk_board_num" column="fk_board_num"/><!-- property는 VO필드이름, column은 오라클 컬럼명 -->
		<result property="representative_name" column="representative_name" />
		<result property="address" column="address" />
		<result property="phone" column="phone" />
		<result property="jurisdiction" column="jurisdiction" />
		<result property="homepage" column="homepage" />
		<result property="academy_image" column="academy_image" />
	</resultMap>
	
	
	<!-- association 으로 선언된 AcademyVO 매핑 -->
	<resultMap id="curriculum" type="com.gukmo.board.model.CurriculumVO">
		<id property="fk_board_num" column="fk_board_num"/><!-- property는 VO필드이름, column은 오라클 컬럼명 -->
		<result property="core_technology" column="core_technology" />
		<result property="academy_name" column="academy_name" />
		<result property="curriculum_start_date" column="curriculum_start_date" />
		<result property="curriculum_end_date" column="curriculum_end_date"	/>
		<result property="recuitment_end_date" column="recuitment_end_date" />
		<result property="join_url" column="join_url" />		
	</resultMap>
	
	<!-- 해시태그 검색용 mapping -->
	<resultMap id="searchList" type="com.gukmo.board.model.BoardVO">
		<id property="board_num" column="board_num"/>
		<result property="category" column="category" />
		<result property="detail_category" column="detail_category" />
		<result property="subject" column="subject"/>
		<result property="content" column="content"/>
		<result property="write_date" column="write_date"/>
		<association property="academy" resultMap="academy"/>
		<association property="curriculum" resultMap="curriculum"/>
		<collection property="hashtags" column="hashtag" javaType="java.util.ArrayList" ofType="com.gukmo.board.model.HashtagVO">
			<id property="hashtag" column="hashtag"/>
		</collection>
	</resultMap>
	
	<select id ="getTotalCnt" parameterType="HashMap" resultType="int">
	    select rno
	    from(
	        select dense_rank()OVER (order by board_num desc) rno,
            		board_num, category, detail_category, subject, content, hashtag, write_date, -- 게시판 글
            		representative_name, address, phone, jurisdiction, homepage, academy_image, -- 학원 글
            		core_technology, academy_name, to_char(curriculum_start_date,'yyyy-mm-dd') as curriculum_start_date,
            		to_char(curriculum_end_date,'yyyy-mm-dd') as curriculum_end_date,
            		to_char(recuitment_end_date,'yyyy-mm-dd') as recuitment_end_date, join_url -- 과정 글
		    from
		    (
		        select board_num, subject, content, category, detail_category, hashtag, write_date
		        from tbl_board B
		        left join
		        (
		            select fk_board_num, hashtag
		            from
		            ( select hashtag_num, fk_board_num, write_date from tbl_hashtag_board_map ) HM
		            join
		            ( select hashtag_num, hashtag from tbl_hashtag ) H
		            on HM.hashtag_num = H.hashtag_num
		        ) join_H
		        on B.board_num = join_H.fk_board_num
		    ) join_BH
		    left join
		    (
		        select fk_board_num, representative_name, address, phone, jurisdiction, homepage, academy_image
		        from tbl_academy
		    ) A
		    on join_BH.board_num = A.fk_board_num
		    left join
		    ( 
		        select fk_board_num, core_technology, academy_name, curriculum_start_date, curriculum_end_date, recuitment_end_date, join_url
		        from tbl_curriculum
		    ) C
		    on join_BH.board_num = C.fk_board_num	        
			where 1 = 1
			<if test= 'searchWord != ""'>
			and subject like '%'||lower(#{searchWord})||'%'
		    or content like '%'||lower(#{searchWord})||'%'
		    or hashtag like '%'||lower(#{searchWord})||'%'
		    </if>
	        order by rno desc
	    )V
	    where rownum = 1
	</select>
	
	

	<select id = "getSearchList" parameterType="HashMap" resultMap="searchList">
		select board_num, category, detail_category, subject, content, hashtag, write_date, -- 게시판 글
            	representative_name, address, phone, jurisdiction, homepage, academy_image, -- 학원 글
            	core_technology, academy_name, to_char(curriculum_start_date,'yyyy-mm-dd') as curriculum_start_date,
            	to_char(curriculum_end_date,'yyyy-mm-dd') as curriculum_end_date,
            	to_char(recuitment_end_date,'yyyy-mm-dd') as recuitment_end_date, join_url -- 과정 글
		from(
    		select dense_rank()OVER (order by board_num desc) rno,
		            board_num, category, detail_category, subject, content, hashtag, write_date, -- 게시판 글
		            representative_name, address, phone, jurisdiction, homepage, academy_image, -- 학원 글
		            core_technology, academy_name, curriculum_start_date, curriculum_end_date, recuitment_end_date, join_url -- 과정 글
		    from
		    (
		        select board_num, subject, content, category, detail_category, hashtag, write_date
		        from tbl_board B left join
		        (
		            select fk_board_num, hashtag
		            from
		            ( select hashtag_num, fk_board_num, write_date from tbl_hashtag_board_map ) HM
		            join
		            ( select hashtag_num, hashtag from tbl_hashtag ) H
		            on HM.hashtag_num = H.hashtag_num
		        ) join_H
		        on B.board_num = join_H.fk_board_num
		    ) join_BH
		    left join
		    (
		        select fk_board_num, representative_name, address, phone, jurisdiction, homepage, academy_image
		        from tbl_academy
		    ) A
		    on join_BH.board_num = A.fk_board_num
		    left join
		    ( 
		        select fk_board_num, core_technology, academy_name, curriculum_start_date, curriculum_end_date, recuitment_end_date, join_url
		        from tbl_curriculum
		    ) C
		    on join_BH.board_num = C.fk_board_num
			where 1= 1
			<if test= 'searchWord != ""'>
			and subject like '%'||lower(#{searchWord})||'%'
		    or content like '%'||lower(#{searchWord})||'%'
		    or hashtag like '%'||lower(#{searchWord})||'%'
		   </if>
		)V
		where rno between #{startRno} and #{endRno}
	</select>


	

	
</mapper>